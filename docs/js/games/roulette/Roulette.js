import { RouletteRenderer } from './RouletteRenderer.js';

export class Roulette {
    constructor(container, casinoManager) {
        this.container = container;
        this.casinoManager = casinoManager;
        this.renderer = null;
        this.bets = []; // Array of { type, value, amount }
        this.isSpinning = false;
        this.currentBetAmount = 10; // Default bet
    }

    init() {
        this.renderGameUI();
        // Delay renderer init slightly to ensure DOM is settled
        setTimeout(() => {
            this.renderer = new RouletteRenderer('roulette-canvas');
        }, 50);
        this.attachEventListeners();
    }

    renderGameUI() {
        this.container.innerHTML = `
            <div class="roulette-game-container">
                <!-- Left Sidebar: Controls -->
                <div class="roulette-sidebar">
                    <div class="sidebar-header">
                        <h3>Betting Controls</h3>
                    </div>
                    
                    <div class="chip-selector-panel">
                        <div class="chip-value-label">Chip Value</div>
                        <div class="chip-buttons">
                            <button class="chip-btn" data-value="10">10</button>
                            <button class="chip-btn" data-value="50">50</button>
                            <button class="chip-btn" data-value="100">100</button>
                            <button class="chip-btn" data-value="500">500</button>
                            <button class="chip-btn" data-value="1000">1k</button>
                            <button class="chip-btn all-in-btn" data-value="all">ALL</button>
                        </div>
                    </div>

                    <div class="bet-info-panel">
                        <div class="bet-label">Total Bet</div>
                        <div class="current-bet-display">
                            $<span id="current-bet-value">0</span>
                        </div>
                    </div>

                    <div class="action-controls">
                        <button id="btn-spin" class="action-btn btn-spin">BET & SPIN</button>
                        <button id="btn-clear" class="action-btn btn-clear">Clear</button>
                        <button id="back-to-lobby" class="back-btn">Back</button>
                    </div>
                </div>

                <!-- Right Main Area: Wheel & Board -->
                <div class="roulette-main-stage">
                    <div class="wheel-section">
                        <div class="wheel-container">
                            <canvas id="roulette-canvas"></canvas>
                            <div id="roulette-result" class="roulette-result"></div>
                        </div>
                    </div>
                    
                    <div class="betting-table-container">
                        <div class="betting-layout">
                            <div class="betting-grid" id="betting-grid">
                                <!-- 0 -->
                                <div class="bet-cell green zero" data-type="number" data-value="0">0</div>
                                <!-- Numbers 1-36 generated by JS -->
                            </div>
                            
                            <div class="outside-bets-row">
                                <div class="bet-cell special" data-type="dozen" data-value="1">1st 12</div>
                                <div class="bet-cell special" data-type="dozen" data-value="2">2nd 12</div>
                                <div class="bet-cell special" data-type="dozen" data-value="3">3rd 12</div>
                            </div>
                            
                            <div class="outside-bets-row">
                                <div class="bet-cell special" data-type="half" data-value="low">1-18</div>
                                <div class="bet-cell special" data-type="parity" data-value="even">EVEN</div>
                                <div class="bet-cell red special" data-type="color" data-value="red"></div>
                                <div class="bet-cell black special" data-type="color" data-value="black"></div>
                                <div class="bet-cell special" data-type="parity" data-value="odd">ODD</div>
                                <div class="bet-cell special" data-type="half" data-value="high">19-36</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        this.generateBettingGrid();
    }

    generateBettingGrid() {
        const grid = document.getElementById('betting-grid');
        const redNumbers = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];

        // Add 0 listener
        grid.querySelector('.zero').addEventListener('click', (e) => this.placeBet('number', 0, e.target));

        for (let i = 1; i <= 36; i++) {
            const cell = document.createElement('div');
            const color = redNumbers.includes(i) ? 'red' : 'black';
            cell.className = `bet-cell ${color}`;
            cell.textContent = i;

            // Click to bet
            cell.addEventListener('click', (e) => this.placeBet('number', i, e.target));

            grid.appendChild(cell);
        }

        // Attach listeners to outside bets
        this.container.querySelectorAll('.bet-cell[data-type]').forEach(btn => {
            if (btn.dataset.type !== 'number') { // Numbers already handled
                btn.addEventListener('click', (e) => {
                    this.placeBet(btn.dataset.type, btn.dataset.value, e.target);
                });
            }
        });
    }

    placeBet(type, value, element) {
        if (this.isSpinning) return;

        const betAmount = this.currentBetAmount;

        if (this.casinoManager.balance < betAmount) {
            alert("Insufficient funds!");
            return;
        }

        this.casinoManager.updateBalance(-betAmount);

        this.bets.push({ type, value, amount: betAmount });

        // Visual Marker
        const marker = document.createElement('div');
        marker.className = 'chip-marker';
        marker.textContent = betAmount >= 1000 ? (betAmount / 1000) + 'k' : betAmount;

        // Color code chips based on value
        if (betAmount >= 1000) marker.style.background = 'radial-gradient(circle at 30% 30%, #000, #333)'; // Black
        else if (betAmount >= 500) marker.style.background = 'radial-gradient(circle at 30% 30%, #9b59b6, #8e44ad)'; // Purple
        else if (betAmount >= 100) marker.style.background = 'radial-gradient(circle at 30% 30%, #e74c3c, #c0392b)'; // Red
        else if (betAmount >= 50) marker.style.background = 'radial-gradient(circle at 30% 30%, #3498db, #2980b9)'; // Blue
        else marker.style.background = 'radial-gradient(circle at 30% 30%, #f1c40f, #f39c12)'; // Gold (Default)

        if (betAmount >= 1000) marker.style.color = '#fff'; // White text for black chip

        // Center the chip
        marker.style.top = '50%';
        marker.style.left = '50%';
        marker.style.transform = 'translate(-50%, -50%)';

        element.style.position = 'relative'; // Ensure parent is relative
        element.appendChild(marker);
    }

    async spin() {
        if (this.isSpinning || this.bets.length === 0) {
            if (this.bets.length === 0) alert("Place a bet first!");
            return;
        }

        this.isSpinning = true;
        document.getElementById('btn-spin').disabled = true;

        // Reset Result Display
        const resultEl = document.getElementById('roulette-result');
        if (resultEl) {
            resultEl.className = 'roulette-result';
            resultEl.textContent = '';
        }

        // Determine result (Random 0-36)
        const winningNumber = Math.floor(Math.random() * 37);
        console.log(`Winning Number: ${winningNumber}`);

        // Spin Wheel
        await this.renderer.spin(winningNumber);

        // Calculate Winnings
        const totalWin = this.calculateWinnings(winningNumber);

        if (totalWin > 0) {
            // Small delay to let the ball settle visually
            setTimeout(() => {
                const resultEl = document.getElementById('roulette-result');

                // Screamer Effect
                resultEl.textContent = winningNumber;
                resultEl.className = `roulette-result show`; // Color handled by CSS text-shadow now

                // Coin Explosion
                this.spawnCoins(50);

                if (totalWin > 0) {
                    // Delay alert slightly so user sees the screamer first
                    setTimeout(() => {
                        this.showVictoryEffects(totalWin);
                        this.casinoManager.updateBalance(totalWin);
                    }, 500);
                }
            }, 500);
        } else {
            // Even if no win, show result
            setTimeout(() => {
                const resultEl = document.getElementById('roulette-result');
                resultEl.textContent = winningNumber;
                resultEl.className = `roulette-result show`;

                // Fewer coins for loss/neutral
                this.spawnCoins(10);
            }, 500);
        }

        // Reset
        this.isSpinning = false;
        document.getElementById('btn-spin').disabled = false;
        this.clearBets(false);
    }

    spawnCoins(amount) {
        for (let i = 0; i < amount; i++) {
            const coin = document.createElement('div');
            coin.className = 'coin-particle';

            // Random start position (explode from center)
            const startX = window.innerWidth / 2;
            const startY = window.innerHeight / 2;

            // Random velocity
            const angle = Math.random() * Math.PI * 2;
            const velocity = 5 + Math.random() * 10;
            const tx = Math.cos(angle) * velocity * 20; // Throw distance X
            const ty = Math.sin(angle) * velocity * 20 - 200; // Throw distance Y (upwards bias)

            coin.style.left = `${startX}px`;
            coin.style.top = `${startY}px`;

            // Custom animation for each coin to spread them out
            coin.animate([
                { transform: `translate(0, 0) rotate(0deg)`, opacity: 1 },
                { transform: `translate(${tx}px, ${ty + 500}px) rotate(${Math.random() * 720}deg)`, opacity: 0 }
            ], {
                duration: 1000 + Math.random() * 1000,
                easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                fill: 'forwards'
            });

            document.body.appendChild(coin);

            // Cleanup
            setTimeout(() => coin.remove(), 2000);
        }
    }

    calculateWinnings(number) {
        let win = 0;
        const redNumbers = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];

        this.bets.forEach(bet => {
            let won = false;
            let payout = 0;

            switch (bet.type) {
                case 'number':
                    if (parseInt(bet.value) === number) {
                        won = true;
                        payout = 35; // x35
                    }
                    break;
                case 'color':
                    const isRed = redNumbers.includes(number);
                    if (number !== 0) {
                        if (bet.value === 'red' && isRed) won = true;
                        if (bet.value === 'black' && !isRed) won = true;
                    }
                    payout = 1; // x2
                    break;
                case 'parity':
                    if (number !== 0) {
                        if (bet.value === 'even' && number % 2 === 0) won = true;
                        if (bet.value === 'odd' && number % 2 !== 0) won = true;
                    }
                    payout = 1; // x2
                    break;
                case 'half':
                    if (number !== 0) {
                        if (bet.value === 'low' && number <= 18) won = true;
                        if (bet.value === 'high' && number >= 19) won = true;
                    }
                    payout = 1; // x2
                    break;
                case 'dozen':
                    if (number !== 0) {
                        if (bet.value == 1 && number <= 12) won = true;
                        if (bet.value == 2 && number > 12 && number <= 24) won = true;
                        if (bet.value == 3 && number > 24) won = true;
                    }
                    payout = 2; // x3
                    break;
            }

            if (won) {
                win += bet.amount * (payout + 1); // Return bet + profit
            }
        });
        return win;
    }

    clearBets(refund = true) {
        if (refund && this.bets.length > 0) {
            const total = this.bets.reduce((sum, b) => sum + b.amount, 0);
            this.casinoManager.updateBalance(total);
        }
        this.bets = [];
        document.querySelectorAll('.chip-marker').forEach(el => el.remove());
    }

    attachEventListeners() {
        document.getElementById('back-to-lobby').addEventListener('click', () => {
            this.casinoManager.returnToLobby();
        });

        document.getElementById('btn-spin').addEventListener('click', () => this.spin());

        document.getElementById('btn-clear').addEventListener('click', () => this.clearBets(true));

        // Chip Selection Listeners
        document.querySelectorAll('.chip-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Remove active class from all
                document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
                // Add to clicked
                e.target.classList.add('active');

                // Update state
                this.currentBetAmount = parseInt(e.target.dataset.value);
                document.getElementById('current-bet-value').textContent = this.currentBetAmount;
            });
        });

        // Set default active
        const defaultChip = document.querySelector('.chip-btn[data-value="10"]');
        if (defaultChip) defaultChip.classList.add('active');

        // ALL IN Button Listener
        const allInBtn = document.querySelector('.all-in-btn');
        if (allInBtn) {
            allInBtn.addEventListener('click', (e) => {
                // Remove active class from chips
                document.querySelectorAll('.chip-btn').forEach(b => b.classList.remove('active'));
                // Add to clicked
                e.target.classList.add('active');

                // Set max bet
                this.currentBetAmount = this.casinoManager.balance;
                document.getElementById('current-bet-value').textContent = this.currentBetAmount;
            });
        }
    }

    showVictoryEffects(amount) {
        // Trigger Flash Mode & Global Shine
        document.body.classList.add('casino-flash-mode');
        document.body.classList.add('global-shine-active');

        setTimeout(() => {
            document.body.classList.remove('casino-flash-mode');
            document.body.classList.remove('global-shine-active');
        }, 4000);

        // 1. Aberrant Rainbow Text
        const winDisplay = document.createElement('div');
        winDisplay.className = 'victory-amount victory-text-rainbow';
        winDisplay.textContent = `+ $${amount}`;
        document.body.appendChild(winDisplay);

        // 2. Victory Images (Ciotti & Sarko)
        const images = ['assets/Ciotti.png', 'assets/sarko.png'];
        images.forEach((src, index) => {
            const img = document.createElement('img');
            img.src = src;
            img.className = `victory-image victory-img-${index}`;
            document.body.appendChild(img);
            setTimeout(() => img.remove(), 4000);
        });

        // 3. Fireworks & Coins
        this.spawnFireworks();
        this.spawnCoins();

        // Cleanup text
        setTimeout(() => winDisplay.remove(), 4000);
    }

    spawnCoins() {
        const coinCount = 100;
        for (let i = 0; i < coinCount; i++) {
            const coin = document.createElement('div');
            coin.className = 'coin-particle';

            // Random start position (top)
            const left = Math.random() * 100;
            coin.style.left = `${left}vw`;
            coin.style.top = '-50px';

            // Random fall duration and delay
            const duration = 1 + Math.random() * 2;
            const delay = Math.random() * 2;

            coin.style.transition = `top ${duration}s ease-in, transform ${duration}s linear`;

            document.body.appendChild(coin);

            // Trigger animation
            requestAnimationFrame(() => {
                coin.style.top = '110vh';
                coin.style.transform = `rotateY(${Math.random() * 720}deg) rotateX(${Math.random() * 720}deg)`;
            });

            setTimeout(() => coin.remove(), (duration + delay) * 1000);
        }
    }

    spawnFireworks() {
        const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
        const explosionCount = 10;

        for (let e = 0; e < explosionCount; e++) {
            setTimeout(() => {
                const cx = Math.random() * window.innerWidth;
                const cy = Math.random() * window.innerHeight;
                const color = colors[Math.floor(Math.random() * colors.length)];

                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'firework-particle';
                    particle.style.backgroundColor = color;
                    particle.style.left = `${cx}px`;
                    particle.style.top = `${cy}px`;

                    const angle = (Math.PI * 2 * i) / 30;
                    const velocity = 100 + Math.random() * 100;
                    const tx = Math.cos(angle) * velocity;
                    const ty = Math.sin(angle) * velocity;

                    particle.style.transition = 'transform 1s ease-out, opacity 1s ease-out';

                    document.body.appendChild(particle);

                    requestAnimationFrame(() => {
                        particle.style.transform = `translate(${tx}px, ${ty}px) scale(0)`;
                        particle.style.opacity = '0';
                    });

                    setTimeout(() => particle.remove(), 1000);
                }
            }, e * 300);
        }
    }
    destroy() {
        // Cleanup Event Listeners (if any were bound globally)
        // Most are on elements that are removed below, so they are GC'd automatically.

        // Remove DOM elements
        this.container.innerHTML = '';

        // Stop any running animations
        this.isSpinning = false;
    }
}

